//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//							Headers								//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

#include "./Drivers/Timer/timer.h"
#include "./Drivers/I2C/I2C.h"

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//		CONSTANT AND MACRO DEFINITIONS USING #DEFINE 		 	//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

#define BUFFER_SIZE			10
#define MAGN_ADRESS_SLAVE	0x1D
#define TEST_ADDRESS_W		0x26
#define TEST_ADDRESS_R		0x26

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//			ENUMERATIONS AND STRUCTURES AND TYPEDEFS	  		//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

typedef void (* callbackp) (void);

typedef enum { I2C_ERROR,  I2C_OK} I2C_FAIL;

typedef struct{
    int16_t x;
    int16_t y;
    int16_t z;
}SRAWDATA;

typedef struct{
    SRAWDATA pMagnData;
    SRAWDATA pAccelData;
    I2C_FAIL error;
}read_data;

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//						STATIC VARIABLES						//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

static read_data * r_data;
uint8_t Buffer[FXOS8700CQ_READ_LEN];
I2C_COM_CONTROL i2c_com;
read_data data;


////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////
//FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS W FILE LEVEL SCOPE//
////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////

void callback_read (void);
void dummy(void){};

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//					FUNCTION DEFINITIONS						//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

void App_Init (void){
	I2C_init(I2C_0);
	timerInit();
	return;
}

void App_Run (void){
	i2c_com.register_address = TEST_ADDRESS_W;
	i2c_com.data[0] = 0xAB;
	i2c_com.data_size = 1;
	I2C_write_msg(&i2c_com);
	timerDelay(TIMER_MS2TICKS(100));

	i2c_com.data[0] = 0xFF;
    i2c_com.data_size = 1;
    i2c_com.register_address = TEST_ADDRESS_R;
    I2C_read_msg(&i2c_com);
    timerDelay(TIMER_MS2TICKS(1000));
	callback_read();
	return;
}

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//					LOCAL FUNCTION DEFINITIONS					//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

void callback_read(void){

    if(i2c_com.fault == I2C_NO_FAULT){
    	r_data->pAccelData.x = (int16_t)(((Buffer[1] << 8) | Buffer[2]))>> 2;
		r_data->pAccelData.y = (int16_t)(((Buffer[3] << 8) | Buffer[4]))>> 2;
		r_data->pAccelData.z = (int16_t)(((Buffer[5] << 8) | Buffer[6]))>> 2;
        // copy the magnetometer byte data into 16 bit words
        r_data->pMagnData.x = (int16_t)(Buffer[7] << 8) | Buffer[8];
        r_data->pMagnData.y = (int16_t)(Buffer[9] << 8) | Buffer[10];
        r_data->pMagnData.z = (int16_t)(Buffer[11] << 8) | Buffer[12];

        r_data->error = I2C_OK;
    }
    else
        r_data->error = I2C_ERROR;

	return;
}
