//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//	@file		SysTick.c										//
//	@brief		SysTick driver implementation					//
//	@author		Grupo	4										//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//							Headers								//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include "./SysTick.h"
#include "MK64F12.h"
#include "core_cm4.h"
#include "hardware.h"

#ifdef	__DEBUG__
#include "../GPIO/gpio.h"
#include "../../board.h"
#endif	//__DEBUG__

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//		CONSTANT AND MACRO DEFINITIONS USING #DEFINE 		 	//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

#if __CORE_CLOCK__ % SYSTICK_ISR_FREQUENCY_HZ != 0
#warning SYSTICK cannot implement this exact frequency. Using floor(__CORE_CLOCK__/SYSTICK_ISR_FREQUENCY_HZ) instead.
#elif SYSTICK_ISR_FREQUENCY_HZ <= 0
#error SYSTICK frequency must be positive
#endif /* FCLK % SYSTICK_ISR_FREQUENCY_HZ != 0 */

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//			ENUMERATIONS AND STRUCTURES AND TYPEDEFS	  		//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

typedef void (*systick_callback_t)(void);

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//						STATIC VARIABLES						//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

static systick_callback_t callback;

////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////
//FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS W FILE LEVEL SCOPE//
////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//					FUNCTION DEFINITIONS						//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

bool SysTick_Init (void (*funcallback)(void)){
/*****************************************************************
 * @brief Initialize SysTic driver
 * @param funcallback Function to be call every SysTick
 * @return Initialization and registration succeed
 ****************************************************************/
#ifdef	__DEBUG__
	gpioMode(DEBUG_PIN, OUTPUT);
	gpioWrite(DEBUG_PIN, LOW);
#endif	//__DEBUG__
	NVIC_EnableIRQ(SysTick_IRQn);
	if (callback == NULL) {
		SysTick->CTRL = 0x00; 								// enable systick interrupts
		SysTick->LOAD = __CORE_CLOCK__ / (SYSTICK_ISR_FREQUENCY_HZ) - 1;
		SysTick->VAL= 0x00;
		SysTick->CTRL = SysTick_CTRL_CLKSOURCE_Msk| SysTick_CTRL_TICKINT_Msk | SysTick_CTRL_ENABLE_Msk;
		callback = funcallback;		// set ISR
		return true;
	}
	else
		return false;
}

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//							HANDLER								//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

void SysTick_Handler(void){
	// for SysTick, clearing the interrupt flag is not necessary
	// it is not an omission!
#ifdef	__DEBUG__
	gpioWrite(DEBUG_PIN, HIGH);
#endif	//__DEBUG__	
	callback();
#ifdef	__DEBUG__
	gpioWrite(DEBUG_PIN, LOW);
#endif	//__DEBUG__	
}

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
//					LOCAL FUNCTION DEFINITIONS					//
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
